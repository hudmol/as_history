<%= stylesheet_link_tag "#{AppConfig[:frontend_proxy_prefix]}assets/history.css" %>

<script>
 var HISTORY_IN_A_RUSH_TRANSLATIONS = <%== ASUtils.to_json(I18n.backend.send(:translations)[I18n.locale][:plugins][:history][:in_a_rush]) %>;
</script>

<%= javascript_include_tag 'history_in_a_rush' %>


<%# BEGIN REMOVE WHEN AS VERSION INCLUDES #current_record and _sidebar_footer.html.erb %>
<% if controller.action_name == 'show' && !self.methods.include?(:current_record) %>
  <% current_record = self.instance_variables
                          .map{|v| self.instance_variable_get(v) }
                          .find{|v| v.respond_to?(:history) && v.history.is_a?(Hash) && v.history['ref']} %>

  <% if current_record %>
    <script type="text/template" id="historySidebarTemplate">
      <%= render partial: '/sidebar_footer', :locals => {:current_record => current_record} %>
    </script>

    <script>
      $(function() {
        $('#archivesSpaceSidebar .nav').append($(AS.renderTemplate("historySidebarTemplate")));

        $(document).on('loadedrecordform.aspace', function(event, $container) {
          $('#archivesSpaceSidebar .nav').append($(AS.renderTemplate("historySidebarTemplate")));

          if (document.location.hash.startsWith('#tree')) {
            var uri = document.location.hash.split('::')[1];
            uri = uri.replace(/_(\d)/, '\/$1');
            uri = '/history/' + uri;
            $('#as-history-button').attr('href', uri);
          }
        });
      });
    </script>
  <% end %>
<% end %>
<%# END REMOVE WHEN AS VERSION INCLUDES #current_record and _sidebar_footer.html.erb %>


<script type="text/template" id="historyAllButtonTemplate">
  <%= link_to I18n.t("plugins.history.all_menu_button_label"), {:controller => :history, :action => :index, :model => nil} %>
</script>

<script type="text/template" id="historyUserButtonTemplate">
  <%= link_to I18n.t("plugins.history.user_menu_button_label"), {:controller => :history, :action => :index, :model => nil, :user => current_user} %>
</script>

<script>
    // put links in the System menu
    $(function() {
      var setupButtons = function(all_templ, user_templ) {
        $('.system-menu .dropdown-menu').append($('<li class="divider" />'));
        $but = $(AS.renderTemplate(all_templ));
        $('.system-menu .dropdown-menu').append($('<li />').append($but));
        $but = $(AS.renderTemplate(user_templ));
        $('.system-menu .dropdown-menu').append($('<li />').append($but));
        $('.system-menu').show();
      };

      setupButtons("historyAllButtonTemplate", "historyUserButtonTemplate");

    });
</script>


<% if session[:user] && controller.controller_name == 'history' %>
  <%= javascript_include_tag 'history' %>
  <script>

    $(function() {
      var as_history = new ASHistory();
      window.as_history = as_history;

      $('.history-version-box').hover(
        function() {
            $(this).find('.as-history-sb-diff-button').show();
            return true;
        },
        function() {
            $(this).find('.as-history-sb-diff-button').hide();
            return true;
        });
    });

    ASHISTORY_USER = '<%= params[:user] %>';
    ASHISTORY_ID = <%= params[:id] || false %>;
    ASHISTORY_VERSION = <%= params[:version] || data['revision'] || false %>;
    ASHISTORY_DIFF = <%= diff_version %>;

  </script>
<% end %>
